<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>レシピ追加フォーム</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2em;
      background-color: #f9f9f9;
    }
    h1, h2 {
      color: #333;
    }
    label {
      display: block;
      margin-top: 1em;
      font-weight: bold;
    }
    input[type="text"], select {
      width: 100%;
      padding: 6px;
      margin-top: 4px;
      box-sizing: border-box;
    }
    .material-btn {
      margin: 4px;
      padding: 4px 8px;
      background-color: #e0f0ff;
      border: 1px solid #ccc;
      cursor: pointer;
    }
    .material-btn:hover {
      background-color: #c0e0ff;
    }
    .selected-material {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    .fixed-label {
      background-color: #eee;
      padding: 4px 6px;
      border: 1px solid #ccc;
      font-weight: bold;
      user-select: none;
    }
    .material-input {
      flex: 1;
      margin-left: 6px;
    }
    .remove-btn {
      background-color: #ffdddd;
      border: 1px solid #cc0000;
      padding: 2px 6px;
      margin-left: 6px;
      cursor: pointer;
    }
    .remove-btn:hover {
      background-color: #ffbbbb;
    }
    button[type="submit"] {
      margin-top: 2em;
      padding: 8px 16px;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <h1>レシピ追加フォーム</h1>

  <p><strong>次に追加されるID:</strong> {{ next_id }}</p>

  <form method="POST">
    <label>料理名</label>
    <input type="text" name="name" required>

    <label>読み仮名（ひらがなで手入力してください）</label>
    <input type="text" name="reading" required>

    <label>ジャンル</label>
    <select name="genre">
      <option value="和風">和風</option>
      <option value="洋食">洋食</option>
      <option value="中華">中華</option>
    </select>

    <h2>材料一覧（クリックで追加）</h2>
    <div id="material-buttons"></div>

    <h2>漢字で始まる材料</h2>
    <div id="kanji-buttons"></div>

<!-- 手入力で材料を追加 -->
<h2>手入力で材料を追加</h2>
<div id="manual-entry"></div>
<button type="button" onclick="addManualMaterial()">＋ 手入力欄を追加</button>

<!-- 選択中の材料 -->
<h2>選択中の材料（分量を記入してください）</h2>
<div id="selected-materials"></div>
<input type="hidden" name="materials" id="materials-hidden">


<button type="submit" style="margin-top: 2em; padding: 10px 20px; font-size: 1.2em; background-color: #cce5ff; border: 1px solid #007bff; font-weight: bold;">
  ✅ レシピを追加する
</button>
</form>



<script>
  let selectedMaterials = [];

  function renderSelectedMaterials() {
    const container = document.getElementById('selected-materials');
    container.innerHTML = '';
    selectedMaterials.forEach((m, i) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'selected-material';

      if (m.fixed) {
        const label = document.createElement('span');
        label.className = 'fixed-label';
        label.textContent = m.name + ':';

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'material-input';
        input.placeholder = '分量を入力';
        input.value = m.amount || '';
        input.oninput = () => {
          selectedMaterials[i].amount = input.value;
          updateHiddenField();
        };

        wrapper.appendChild(label);
        wrapper.appendChild(input);
      } else {
        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.className = 'material-input';
        nameInput.placeholder = '材料名';
        nameInput.value = m.name || '';
        nameInput.oninput = () => {
          selectedMaterials[i].name = nameInput.value;
          updateHiddenField();
        };

        const amountInput = document.createElement('input');
        amountInput.type = 'text';
        amountInput.className = 'material-input';
        amountInput.placeholder = '分量';
        amountInput.value = m.amount || '';
        amountInput.oninput = () => {
          selectedMaterials[i].amount = amountInput.value;
          updateHiddenField();
        };

        wrapper.appendChild(nameInput);
        wrapper.appendChild(amountInput);
      }

      const del = document.createElement('button');
      del.textContent = '×';
      del.className = 'remove-btn';
      del.onclick = () => {
        selectedMaterials.splice(i, 1);
        renderSelectedMaterials();
        updateHiddenField();
      };

      wrapper.appendChild(del);
      container.appendChild(wrapper);
    });
  }

  function updateHiddenField() {
    const values = selectedMaterials.map(m => {
      return (m.name || '') + ':' + (m.amount || '');
    });
    document.getElementById('materials-hidden').value = values.join(',');
  }

  function addManualMaterial() {
    selectedMaterials.push({ fixed: false, name: '', amount: '' });
    renderSelectedMaterials();
    updateHiddenField();
  }

  fetch('/material-groups')
    .then(res => res.json())
    .then(data => {
      const kanaGroups = data.kana;
      const kanjiList = data.kanji;

      const kanaContainer = document.getElementById('material-buttons');
      for (const [row, items] of Object.entries(kanaGroups)) {
        const section = document.createElement('div');
        section.innerHTML = `<strong>${row}行:</strong><br>`;
        items.forEach(name => {
          const btn = document.createElement('button');
          btn.textContent = name;
          btn.className = 'material-btn';
          btn.type = 'button';
          btn.onclick = () => {
            if (!selectedMaterials.some(m => m.fixed && m.name === name)) {
              selectedMaterials.push({ fixed: true, name: name, amount: '' });
              renderSelectedMaterials();
              updateHiddenField();
            }
          };
          section.appendChild(btn);
        });
        kanaContainer.appendChild(section);
      }

      const kanjiContainer = document.getElementById('kanji-buttons');
      const kanjiSection = document.createElement('div');
      kanjiSection.innerHTML = `<strong>漢字で始まる材料:</strong><br>`;
      kanjiList.forEach(name => {
        const btn = document.createElement('button');
        btn.textContent = name;
        btn.className = 'material-btn';
        btn.type = 'button';
        btn.onclick = () => {
          if (!selectedMaterials.some(m => m.fixed && m.name === name)) {
            selectedMaterials.push({ fixed: true, name: name, amount: '' });
            renderSelectedMaterials();
            updateHiddenField();
          }
        };
        kanjiSection.appendChild(btn);
      });
      kanjiContainer.appendChild(kanjiSection);
    });
</script>
</body>
</html>
